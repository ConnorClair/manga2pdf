<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rename, Move Images and Create PDF</title>
  <style>
    /* General page styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f9;
      color: #333;
    }
    
    header {
      background-color: #A94A4A;
      color: white;
      text-align: center;
      padding: 20px;
    }

    h1 {
      font-size: 2em;
      margin: 0;
    }

    /* Main content container */
    .container {
      width: 80%;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    /* Buttons */
    button {
      padding: 10px 20px;
      font-size: 1em;
      background-color: #EAE2C6;
      color: black;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:disabled {
      background-color: #EAE2C6;
      cursor: not-allowed;
    }

    button:hover {
      background-color: #889E73;
    }

    /* Progress bar container */
    .progress-container {
      width: 100%;
      height: 30px;
      margin: 20px 0;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      transition: width 0.3s;
    }

    .progress-bar-green {
      background-color: #4CAF50;
    }

    .progress-bar-blue {
      background-color: #2196F3;
    }

    /* ETA and text */
    #progress-text, #eta-text {
      font-size: 1.1em;
      margin-top: 10px;
      color: #555;
    }

    #eta-text {
      font-weight: bold;
    }

    /* Styling for file selection and information */
    #selectMainFolder {
      margin-bottom: 20px;
    }

    .file-info {
      font-size: 1.1em;
      color: #777;
      margin-top: 10px;
    }

    .file-info span {
      font-weight: bold;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .container {
        width: 95%;
        padding: 15px;
      }

      button {
        width: 100%;
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Batch Manga To PDF</h1>
  </header>

  <div class="container">
    <button id="selectMainFolder">Select Main Folder</button>
    <button id="processFiles" disabled>Process Files</button>

    <div class="progress-container">
      <div id="progress-bar" class="progress-bar progress-bar-green"></div>
    </div>
    <div id="progress-text">Select a folder to begin.</div>

    <div class="progress-container">
      <div id="pdf-progress-bar" class="progress-bar progress-bar-blue"></div>
    </div>
    <div id="eta-text">Estimated time remaining: 0m 0s</div>

    <div id="file-info" class="file-info"></div>
  </div>

  <!-- Include jsPDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  let mainFolderHandle;
  let mainFolderName = '';
  let totalFiles = 0;
  let processedFiles = 0;
  let totalImages = 0;
  let processedImages = 0;
  let startTime, processingStartTime;

  const progressBar = document.getElementById("progress-bar");
  const pdfProgressBar = document.getElementById("pdf-progress-bar");
  const progressText = document.getElementById("progress-text");
  const etaText = document.getElementById("eta-text");
  const fileInfo = document.getElementById("file-info");

  async function selectMainFolder() {
    try {
      mainFolderHandle = await window.showDirectoryPicker();
      mainFolderName = mainFolderHandle.name;
      document.getElementById("processFiles").disabled = false;
      progressText.textContent = `Selected folder: ${mainFolderName}`;
    } catch (err) {
      console.error("Folder selection canceled", err);
    }
  }

  // Reset progress bars and text when starting a new process
  function resetProgressBars() {
    progressBar.style.width = "0%";
    pdfProgressBar.style.width = "0%";
    progressText.textContent = "Processing files: 0 of 0 completed (0%)";
    etaText.textContent = "Estimated time remaining: 0m 0s";
    fileInfo.textContent = "";
  }

  async function updateProgressBar() {
    const percentage = totalFiles > 0 ? (processedFiles / totalFiles) * 100 : 0;
    progressBar.style.width = `${percentage}%`;
    progressText.textContent = `Processing files: ${processedFiles} of ${totalFiles} completed (${Math.round(percentage)}%)`;
  }

  async function updatePdfProgressBar() {
    const percentage = totalImages > 0 ? (processedImages / totalImages) * 100 : 0;
    pdfProgressBar.style.width = `${percentage}%`;
  }

  async function updateETA(startTime, processed, total) {
    const elapsedTime = Date.now() - startTime;
    const estimatedTotalTime = (elapsedTime / processed) * total;
    const remainingTime = estimatedTotalTime - elapsedTime;

    const minutesRemaining = Math.floor(remainingTime / 60000);
    const secondsRemaining = Math.floor((remainingTime % 60000) / 1000);

    etaText.textContent = `Estimated time remaining: ${minutesRemaining}m ${secondsRemaining}s`;
  }

  async function countFilesInFolder(folderHandle) {
    let count = 0;
    for await (const [, handle] of folderHandle.entries()) {
      if (handle.kind === "directory") {
        for await (const [, fileHandle] of handle.entries()) {
          if (fileHandle.kind === "file" && fileHandle.name.match(/\.(jpg|jpeg|png|gif)$/)) {
            count++;
          }
        }
      }
    }
    return count;
  }

  async function processFiles() {
    if (!mainFolderHandle) {
      progressText.textContent = "No folder selected.";
      return;
    }

    try {
      resetProgressBars(); // Reset progress bars and text for a new folder

      startTime = Date.now();
      processingStartTime = startTime;

      const destinationFolderHandle = await mainFolderHandle.getDirectoryHandle("AllImages", { create: true });
      totalFiles = await countFilesInFolder(mainFolderHandle);
      processedFiles = 0;
      await updateProgressBar();

      let imageFiles = [];
      for await (const [subfolderName, subfolderHandle] of mainFolderHandle.entries()) {
        if (subfolderHandle.kind === "directory") {
          let subfolderImages = [];
          for await (const [fileName, fileHandle] of subfolderHandle.entries()) {
            if (fileHandle.kind === "file" && fileName.match(/\.(jpg|jpeg|png|gif)$/)) {
              const file = await fileHandle.getFile();
              subfolderImages.push({ subfolderName, fileName, file });
            }
          }
          subfolderImages.sort((a, b) => {
            const numA = parseInt(a.fileName.replace(/\D/g, ''), 10);
            const numB = parseInt(b.fileName.replace(/\D/g, ''), 10);
            return numA - numB;
          });
          imageFiles.push({ subfolderName, images: subfolderImages });
        }
      }

      totalImages = imageFiles.reduce((sum, folder) => sum + folder.images.length, 0);
      processedImages = 0;

      for (let folder of imageFiles) {
        for (let i = 0; i < folder.images.length; i++) {
          const { subfolderName, fileName, file } = folder.images[i];
          const newFileName = `${subfolderName}-${fileName}`;
          const destinationFileHandle = await destinationFolderHandle.getFileHandle(newFileName, { create: true });
          const writable = await destinationFileHandle.createWritable();
          await writable.write(file);
          await writable.close();

          processedFiles++;
          await updateProgressBar();
          updateETA(processingStartTime, processedFiles, totalFiles);
        }
      }

      await createPdf(imageFiles);

    } catch (err) {
      console.error("Error processing files", err);
      progressText.textContent += `Error: ${err.message}`;
    }
  }

  async function convertToBase64(arrayBuffer) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = function() {
        resolve(reader.result.split(',')[1]);
      };
      reader.onerror = reject;
      const blob = new Blob([arrayBuffer]);
      reader.readAsDataURL(blob);
    });
  }

  async function createPdf(imageFiles) {
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      for (let folder of imageFiles) {
        const { subfolderName, images } = folder;
        for (let i = 0; i < images.length; i++) {
          const { file } = images[i];
          const imgData = await file.arrayBuffer();
          const imgBase64 = await convertToBase64(imgData);

          if (i > 0) {
            pdf.addPage();
          }
          pdf.addImage(imgBase64, 'JPEG', 0, 20, 210, 297);

          processedImages++;
          await updatePdfProgressBar();
          updateETA(processingStartTime, processedImages, totalImages);
        }
      }

      pdf.save(`${mainFolderName}.pdf`);

      const totalTime = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(totalTime / 60);
      const seconds = totalTime % 60;

      progressText.textContent += `\nPDF compression complete. Total time: ${minutes}m ${seconds}s.`;

    } catch (err) {
      console.error("Error creating PDF", err);
      progressText.textContent += `Error: ${err.message}`;
    }
  }

  document.getElementById("selectMainFolder").addEventListener("click", selectMainFolder);
  document.getElementById("processFiles").addEventListener("click", processFiles);
</script>

</body>
</html>
